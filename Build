@echo off
setlocal enabledelayedexpansion

:: --- SETUP ---
echo ===========================================
echo   INTERACTIVE SOLUTION REBUILD TOOL
echo ===========================================
echo.

:: 1. Ask for the Base Path
set /p "BASE_PATH=Enter the full path to your Solution folder: "
if "%BASE_PATH:~-1%"=="\" set "BASE_PATH=%BASE_PATH:~0,-1%"

:: 2. Configure Build Tool
set BUILD_TOOL="C:\Program Files\Microsoft Visual Studio\2022\Community\Msbuild\Current\Bin\MSBuild.exe"
set BUILD_FLAGS=/p:Configuration=Release /t:Rebuild /m /nologo /verbosity:minimal

:: 3. DEFINE PROJECTS (RelativeProjPath , RelativeOutPath , Destination)
:: Add as many as you need here. The menu builds itself.
set "p[1]=ProjectA\ProjectA.csproj , ProjectA\bin\Release , C:\Deploy\AppA"
set "p[2]=ProjectB\ProjectB.csproj , ProjectB\bin\Release , C:\Deploy\AppB"
set "p[3]=ProjectC\ProjectC.csproj , ProjectC\bin\Release , C:\Deploy\AppC"

:: Calculate project count
set "count=0"
for /f "tokens=1 delims=[=]" %%a in ('set p[') do set /a "count+=1"

:: 4. DISPLAY MENU
echo Available Projects:
for /L %%i in (1,1,%count%) do (
    for /f "tokens=1 delims=," %%a in ("!p[%%i]!") do (
        echo   %%i. %%~na
    )
)
echo   A. ALL Projects
echo.
set /p "USER_INPUT=Enter IDs (e.g. 1,3) or 'A' for all: "

:: 5. NORMALIZE SELECTION
if /I "%USER_INPUT%"=="A" (
    set "SELECTION="
    for /L %%i in (1,1,%count%) do (
        set "SELECTION=!SELECTION! %%i"
    )
) else (
    set "SELECTION=%USER_INPUT%"
)

:: --- EXECUTION ---
echo.
echo Processing selection...
echo -------------------------------------------

for %%S in (%SELECTION%) do (
    set "ID=%%S"
    if defined p[!ID!] (
        for /f "tokens=1,2,3 delims=," %%a in ("!p[!ID!]!") do (
            set "REL_PROJ=%%a"
            set "REL_OUT=%%b"
            set "DEST=%%c"

            :: Trim spaces
            for /f "tokens=* delims= " %%p in ("!REL_PROJ!") do set "REL_PROJ=%%p"
            for /f "tokens=* delims= " %%o in ("!REL_OUT!") do set "REL_OUT=%%o"
            for /f "tokens=* delims= " %%d in ("!DEST!") do set "DEST=%%d"

            echo.
            echo [EXECUTING] !REL_PROJ!
            
            %BUILD_TOOL% "%BASE_PATH%\!REL_PROJ!" %BUILD_FLAGS%
            
            if !errorlevel! neq 0 (
                echo [ERROR] Build failed. Skipping copy.
            ) else (
                echo [SUCCESS] Copying to !DEST!...
                if not exist "!DEST!" mkdir "!DEST!"
                robocopy "%BASE_PATH%\!REL_OUT!" "!DEST!" /E /Z /R:1 /W:2 /NJH /NJS
                echo [DONE] Project updated.
            )
        )
    ) else (
        echo [SKIP] ID !ID! is invalid.
    )
)

echo.
echo -------------------------------------------
echo Process Complete.
pause
